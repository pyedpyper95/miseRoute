<?php
/**
 * Created by PhpStorm.
 * User: HojaeYoon
 * Date: 2018. 6. 7.
 * Time: PM 11:20
 */

$districtData = ["도봉구", "은평구", "동대문구", "동작구","금천구", "구로구", "종로구", "강북구", "중랑구", "강남구", "강서구", "중구", "강동구", "광진구", "마포구", "서초구", "성북구", "노원구", "송파구", "서대문구","양천구", "영등포구","관악구", "성동구", "용산구"];
function dustData($districtName){
    $serviceKey = "y2s66%2BU5R%2FOg8sYEnMVG6NNrMBAtbewSeGF9UegErv22%2FeW%2BU0pun0n2jjOAH5s1B8KZezRlY8i%2B7YvWkLolxQ%3D%3D";
    $url = "http://openapi.airkorea.or.kr/openapi/services/rest/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty?serviceKey=".$serviceKey."&numOfRows=10&pageSize=10&pageNo=1&startPage=1&stationName=".$districtName."&dataTerm=DAILY&ver=1.3&_returnType=json";
    header('Access-Control-Allow-Origin: *');
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_URL, $url);
    $dust = curl_exec($ch);
    $err2 = curl_error($ch);
    curl_close($ch);
    if ($err2) {
        return "error";
    } else {
        $dust = json_decode($dust,true);
        return $dust;
    }
}

$dDustPair = [];
$boundary_file = "{
  \"종로구\": {
    \"boundary\":[126.976541,37.630634,126.987015,37.611117,126.985366,37.605054,126.973146,37.600811,126.97373,37.597644,126.989271,37.591732,127.000999,37.592932,127.008899,37.580991,127.023226,37.57858,127.023427,37.572277,126.972742,37.569794,126.966732,37.566433,126.953608,37.579414,126.960727,37.581337,126.949834,37.609343,126.951769,37.624872,126.971841,37.63283,126.976541,37.630634]
  },
  \"중구\": {
    \"boundary\":[127.023503,37.570383,127.026546,37.563897,127.008663,37.544513,127.004282,37.550911,126.995377,37.547772,126.985465,37.554287,126.961806,37.552879,126.969504,37.568986,127.023503,37.570383]
  },
  \"용산구\": {
    \"boundary\":[126.96912,37.554637,126.985465,37.554287,126.995377,37.547772,127.004282,37.550911,127.00938,37.540211,127.020983,37.535652,126.989434,37.513239,126.961258,37.514321,126.943621,37.529951,126.96912,37.554637]
  },
  \"성동구\": {
    \"boundary\":[127.042241,37.573559,127.058769,37.562994,127.073761,37.559975,127.056628,37.529633,127.029916,37.539397,127.020983,37.535652,127.008394,37.542393,127.026546,37.563897,127.023427,37.572277,127.042241,37.573559]
  },
  \"광진구\":{
    \"boundary\":[127.101703,37.573095,127.101211,37.560559,127.11315,37.560866,127.113956,37.553864,127.098829,37.528175,127.072917,37.524244,127.056628,37.529633,127.07864,37.572398,127.101703,37.573095]
  },
  \"동대문구\":{
    \"boundary\":[127.071849,37.606477,127.069689,37.595422,127.078708,37.57317,127.072165,37.560581,127.058769,37.562994,127.042241,37.573559,127.023427,37.572277,127.023219,37.578883,127.042027,37.597471,127.071849,37.606477]
  },
  \"중랑구\":{
    \"boundary\":[127.105883,37.621323,127.117117,37.618334,127.113899,37.600503,127.117891,37.594544,127.099553,37.573066,127.07864,37.572398,127.069567,37.596041,127.071444,37.616436,127.105883,37.621323]
  },
  \"성북구\":{
    \"boundary\":[126.984681,37.63711,127.022294,37.611811,127.030254,37.612869,127.030471,37.60968,127.050048,37.624974,127.062076,37.614917,127.071251,37.61691,127.071781,37.607352,127.042027,37.597471,127.022933,37.578344,127.014744,37.582764,127.008899,37.580991,127.000999,37.592932,126.989271,37.591732,126.97373,37.597644,126.973146,37.600811,126.985366,37.605054,126.986752,37.615226,126.97513,37.63193,126.984681,37.63711]
  },
  \"강북구\":{
    \"boundary\":[127.006628,37.685599,127.018575,37.670507,127.013303,37.650986,127.024677,37.647949,127.050048,37.624974,127.030471,37.60968,127.030254,37.612869,127.010769,37.616986,127.007983,37.624513,126.9846,37.637209,126.979503,37.656375,126.994213,37.666825,126.991793,37.680016,127.006628,37.685599]
  },
  \"도봉구\":{
    \"boundary\":[127.019627,37.701632,127.028089,37.701142,127.032526,37.692264,127.049036,37.694497,127.051983,37.685352,127.048885,37.669642,127.054999,37.641306,127.050326,37.645687,127.041542,37.631823,127.024677,37.647949,127.012751,37.652178,127.018575,37.670507,127.008166,37.680861,127.008171,37.69249,127.019627,37.701632]
  },
  \"노원구\":{
    \"boundary\":[127.077406,37.696935,127.095858,37.689411,127.091894,37.679737,127.096768,37.661464,127.0861,37.656459,127.092915,37.655426,127.094818,37.646106,127.111124,37.643065,127.112105,37.633161,127.105436,37.627683,127.105777,37.621376,127.097154,37.617591,127.086156,37.62083,127.062485,37.614827,127.041542,37.631823,127.046467,37.641805,127.051309,37.645741,127.054999,37.641306,127.055955,37.646516,127.048885,37.669642,127.050839,37.687572,127.077406,37.696935]
  },
  \"은평구\":{
    \"boundary\":[126.95263,37.655268,126.972249,37.633144,126.952224,37.625366,126.95043,37.60842,126.93991,37.603476,126.940729,37.599212,126.930713,37.595031,126.928171,37.588925,126.920822,37.583441,126.913197,37.587575,126.901686,37.576457,126.882287,37.591477,126.885967,37.594519,126.887308,37.589134,126.899889,37.590407,126.900985,37.613311,126.912516,37.642231,126.90532,37.649462,126.914243,37.645227,126.934786,37.651189,126.946368,37.659422,126.95263,37.655268]
  },
  \"서대문구\":{
    \"boundary\":[126.950991,37.608853,126.960727,37.581337,126.953608,37.579414,126.969645,37.562551,126.958761,37.557195,126.936918,37.555638,126.926675,37.559367,126.925999,37.565686,126.901655,37.576001,126.913197,37.587575,126.921815,37.583998,126.930713,37.595031,126.940729,37.599212,126.93991,37.603476,126.950991,37.608853]
  },
  \"마포구\":{
    \"boundary\":[126.890829,37.584414,126.936918,37.555638,126.96309,37.558719,126.963744,37.549342,126.943621,37.529951,126.934758,37.536779,126.900766,37.54467,126.857458,37.571611,126.857889,37.576159,126.875921,37.580135,126.882287,37.591477,126.890829,37.584414]
  },
  \"양천구\": {
    \"boundary\": [126.870345,37.548435,126.887339,37.543935,126.89009,37.530913,126.880555,37.525759,126.87228,37.505937,126.852162,37.510987,126.840749,37.506887,126.837369,37.500535,126.831192,37.509205,126.82437,37.509427,126.828867,37.527061,126.821577,37.540337,126.82972,37.546923,126.840527,37.52707,126.864055,37.530333,126.864329,37.551925,126.870345,37.548435]
  },
  \"강서구\":{
    \"boundary\":[126.816566,37.594434,126.857796,37.575181,126.858447,37.570159,126.889801,37.550707,126.886212,37.544131,126.864329,37.551925,126.864055,37.530333,126.840527,37.52707,126.829414,37.547064,126.82545,37.54158,126.802887,37.543616,126.794651,37.53629,126.791816,37.544377,126.771198,37.549246,126.764313,37.555876,126.777928,37.560429,126.774977,37.568402,126.780213,37.567832,126.782923,37.574241,126.79334,37.577754,126.800827,37.588544,126.79706,37.599032,126.800639,37.604646,126.816566,37.594434]
  },
  \"구로구\":{
    \"boundary\":[126.891654,37.510586,126.896568,37.489587,126.903274,37.485514,126.899,37.479481,126.874787,37.48591,126.877223,37.48847,126.868683,37.495756,126.852607,37.482469,126.846526,37.482232,126.84537,37.47433,126.831775,37.478277,126.821723,37.475816,126.822776,37.490508,126.812707,37.497159,126.819387,37.499829,126.822647,37.508296,126.830875,37.509404,126.837613,37.500492,126.840749,37.506887,126.852162,37.510987,126.87228,37.505937,126.879518,37.517303,126.891654,37.510586]
  },
  \"금천구\":{
    \"boundary\":[126.895909,37.478983,126.909771,37.481477,126.914206,37.458595,126.922516,37.457773,126.92887,37.451387,126.908251,37.434207,126.902831,37.434634,126.89412,37.453164,126.886268,37.456913,126.88913,37.462058,126.873492,37.485195,126.878745,37.487116,126.895909,37.478983]
  },
  \"영등포구\":{
    \"boundary\":[126.940454,37.532254,126.950454,37.520558,126.926061,37.516629,126.920237,37.49873,126.900556,37.48616,126.893765,37.497246,126.895186,37.508682,126.879518,37.517303,126.880555,37.525759,126.891571,37.533672,126.885321,37.546838,126.889801,37.550707,126.940454,37.532254]
  },
  \"동작구\":{
    \"boundary\":[126.953473,37.51807,126.980192,37.512648,126.980758,37.503273,126.98789,37.499137,126.982956,37.496902,126.981631,37.47719,126.970543,37.475895,126.964926,37.480253,126.960401,37.494354,126.939559,37.491404,126.927453,37.495477,126.92435,37.490493,126.903274,37.485514,126.911865,37.496432,126.920237,37.49873,126.926061,37.516629,126.953473,37.51807]
  },
  \"관악구\":{
    \"boundary\":[126.92923,37.494919,126.939559,37.491404,126.960401,37.494354,126.964926,37.480253,126.970543,37.475895,126.981752,37.477193,126.988675,37.45866,126.962318,37.441178,126.939483,37.436485,126.922516,37.457773,126.914206,37.458595,126.909771,37.481477,126.899515,37.480871,126.92923,37.494919]
  },
  \"서초구\":{
    \"boundary\":[127.020611,37.513304,127.034173,37.485091,127.041405,37.486098,127.05013,37.470625,127.061672,37.469484,127.06987,37.475757,127.084359,37.476031,127.09606,37.463023,127.088053,37.445583,127.071713,37.442317,127.070684,37.430456,127.052315,37.429032,127.035923,37.439678,127.037163,37.455844,127.031327,37.4663,127.017916,37.456132,127.011117,37.455913,127.003478,37.467785,126.987694,37.459927,126.981631,37.47719,126.982956,37.496902,126.98789,37.499137,126.980758,37.503273,126.980192,37.512648,126.998074,37.517235,127.011925,37.528373,127.020611,37.513304]
  },
  \"강남구\":{
    \"boundary\":[127.043284,37.534136,127.067024,37.525613,127.073244,37.502659,127.109125,37.489042,127.122368,37.46776,127.116813,37.459117,127.106372,37.463063,127.0982,37.459229,127.084359,37.476031,127.06987,37.475757,127.053871,37.469256,127.041405,37.486098,127.034173,37.485091,127.011925,37.528373,127.029916,37.539397,127.043284,37.534136]
  },
  \"송파구\":{
    \"boundary\":[127.12881,37.524322,127.145477,37.517016,127.139771,37.516053,127.143474,37.514273,127.141204,37.505982,127.161447,37.50014,127.149456,37.478967,127.139075,37.473934,127.13077,37.475909,127.135463,37.469804,127.125047,37.470053,127.12236,37.465738,127.105748,37.491942,127.071275,37.504045,127.066559,37.521461,127.067024,37.525613,127.098829,37.528175,127.10963,37.544003,127.123279,37.539061,127.119186,37.528616,127.12881,37.524322]
  },
  \"강동구\":{
    \"boundary\":[127.177046,37.579992,127.183388,37.545941,127.163263,37.545552,127.145073,37.517439,127.119186,37.528616,127.123279,37.539061,127.10963,37.544003,127.11315,37.560866,127.164786,37.580058,127.177046,37.579992]
  }
}";

$boundary_file = json_decode($boundary_file,true);

function calcGrade($value){
    if($value == "-"){
        return 0;
    } elseif($value>=0 && $value<=15){
        return 1;
    } elseif($value>=16 && $value <= 30){
        return 2;
    } elseif($value>=31 && $value <= 40){
        return 3;
    } elseif($value>=41 && $value <= 50){
        return 4;
    } elseif($value>=51 && $value <= 75){
        return 5;
    } elseif($value>=76 && $value <= 100){
        return 6;
    } elseif($value>=101 && $value <= 150){
        return 7;
    } else{
        return 8;
    }
}
function findStrokeData($calculatedGrade) {
    switch($calculatedGrade) {
        case 1:
            return "#73BBD7 최고";
        case 2:
            return "#519CA9 좋음";
        case 3:
            return "#47B7A3 양호";
        case 4:
            return "#6EBC54 보통";
        case 5:
            return "#BF7C28 나쁨";
        case 6:
            return "#CC5E2F 상당히나쁨";
        case 7:
            return "#BE4935 매우나쁨";
        case 8:
            return "#4D4A2A 최악";
        case 0:
            return "#000000 정보없음";
    }
}

for ($x = 0; $x < 25; $x++) {
    $districtName = $districtData[$x];
    $dustData = dustData($districtName);
    if($dustData == "error"){
        echo $dustData;
    }
    $pm10 = $dustData['list'][0]['pm10Value'];
    if($pm10 == '-'){
        $pm10 = $dustData['list'][0]['pm10Value24'];
    }
    $dDustPair[$districtName]['level'] = $pm10;

    $dDustPair[$districtName]['grade'] = calcGrade($pm10);
    $dDustPair[$districtName]['color'] = findStrokeData($dDustPair[$districtName]['grade']);
    for($i=0; $i<sizeof($boundary_file[$districtName]['boundary'])/2; $i++){
        $dDustPair[$districtName]['geometry'][$i]['lat'] = $boundary_file[$districtName]['boundary'][2*$i+1];
        $dDustPair[$districtName]['geometry'][$i]['lng'] = $boundary_file[$districtName]['boundary'][2*$i];
    }
}
$dDustPair = json_encode($dDustPair);
